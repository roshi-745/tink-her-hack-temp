<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Safar Monitoring</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>

body::before{
content:"";
position:fixed;
width:100%;
height:100%;
background:url("Gemini_Generated_Image_bikbc2bikbc2bikb.png") center/cover no-repeat;
filter:blur(4px) brightness(0.6);
z-index:-1;
}

body{
color:white;
font-family:Arial;
}

.dashboard{
background:rgba(0,0,0,0.6);
padding:30px;
border-radius:15px;
margin-top:60px;
}

.popup{
position:fixed;
top:50%;
left:50%;
transform:translate(-50%,-50%);
background:black;
padding:30px;
border-radius:10px;
display:none;
text-align:center;
}

</style>
</head>

<body>

<div class="container">

<div class="dashboard col-md-6 mx-auto">

<h3 class="text-success text-center">
üü¢ Monitoring Active
</h3>

<hr>

<h5 class="text-center">Next Check-In In</h5>

<h1 id="timer" class="text-center"></h1>

<hr>

<h5>Activity Log</h5>
<div id="log"></div>

</div>
</div>

<div class="d-flex justify-content-center gap-3 mt-3">

<button class="btn btn-warning btn-sm px-3"
onclick="unsafeAlert()">
‚ö† I Feel Unsafe
</button>

<button class="btn btn-danger btn-sm px-3"
onclick="manualPanic()">
üö® Panic
</button>

<button class="btn btn-dark btn-sm px-3"
onclick="toggleBreak()">
‚è∏ Break
</button>

<button 
id="resetBtn"
class="btn btn-secondary btn-sm px-3"
onclick="resetSystem()"
style="display:none;">
üîÑ Reset Monitoring
</button>

</div>

<!-- CHECK IN POPUP -->
<div class="popup" id="checkPopup">

<h4>Safety Check-In</h4>

<p>You have 60 seconds to respond</p>

<h2 id="popupTimer">60</h2>

<button class="btn btn-success"
onclick="userSafe()">‚úÖ I'm Safe</button>
<button class="btn btn-warning"
onclick="unsafeAlert()">
‚ö† I Feel Unsafe
</button>

<button class="btn btn-danger"
onclick="manualPanic()">
üö® Panic Button
</button>

</div>


<audio id="beep">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>

/* ======================
GLOBAL STATES
======================*/

let count=0;

let mainTimer=null;
let popupTimer=null;

let emergencyActive=false;
let paused=false;
let popupActive=false;

/* ======================
GET DATA
======================*/

let interval =
parseInt(localStorage.getItem("interval")) || 1;

/* SAFE END TIME */
let endTime =
localStorage.getItem("endTime") || "23:59";

let userName =
localStorage.getItem("userName") || "User";

let timeLeft = interval*60;


/* ======================
SHOW INITIAL TIMER
======================*/

updateTimerDisplay();


/* ======================
DISPLAY FUNCTION
======================*/

function updateTimerDisplay(){

let m=Math.floor(timeLeft/60);
let s=timeLeft%60;

document.getElementById("timer")
.innerHTML=
`${m}:${s.toString().padStart(2,'0')}`;
}


/* ======================
LOG
======================*/

function log(msg){
document.getElementById("log")
.innerHTML+="<br>"+msg;
}


/* ======================
END TIME CHECK
======================*/

function journeyEnded(){

let now=new Date();

let [h,m]=endTime.split(":");

let end=new Date();
end.setHours(parseInt(h),parseInt(m),0);

return now>=end;
}

/* ======================
MAIN TIMER
======================*/

function startMainTimer(){

mainTimer=setInterval(()=>{

if(emergencyActive) return;
if(paused || popupActive) return;

if(journeyEnded()){
document.getElementById("timer")
.innerHTML="‚úÖ Journey Completed";
clearInterval(mainTimer);
return;
}

timeLeft--;

updateTimerDisplay();

if(timeLeft<=0){
startCheckIn();
}

},1000);

}

/* ======================
BREAK BUTTON
======================*/

function toggleBreak(){

if(emergencyActive) return;

paused=!paused;

alert(
paused ?
"Monitoring Paused":
"Monitoring Resumed"
);

}

/* ======================
CHECK IN
======================*/

function startCheckIn(){

count++;

popupActive=true;

document.getElementById("checkPopup")
.style.display="block";

log("Check-In Requested");

let seconds=60;

popupTimer=setInterval(()=>{

document.getElementById("popupTimer")
.innerText=seconds;

seconds--;

if(seconds<0){

clearInterval(popupTimer);
popupActive=false;

document.getElementById("checkPopup")
.style.display="none";

//autoPanic(); 

if(count>=2){

    autoPanic(); 

}
else{

    count++;

}

}

},1000);

}


/* ======================
SAFE BUTTON
======================*/

function userSafe(){

clearInterval(popupTimer);

popupActive=false;

document.getElementById("checkPopup")
.style.display="none";

timeLeft=interval*60;

updateTimerDisplay();

log("User Safe");

}


/* ======================
LOCATION
======================*/

function getLocation(callback){

if(!navigator.geolocation){
callback("Unknown","Unknown");
return;
}

navigator.geolocation.getCurrentPosition(
pos=>{
callback(
pos.coords.latitude,
pos.coords.longitude
);
},
()=>{
callback("Unknown","Unknown");
});
}


/* ======================
UNSAFE BUTTON
======================*/

function unsafeAlert(){

clearInterval(popupTimer);

popupActive=false;

document.getElementById("checkPopup")
.style.display="none";

alert("Emergency Contact Called");

log("Unsafe alert sent");

}


/* ======================
üö® PANIC BUTTON
======================*/

function manualPanic(){

if(emergencyActive) return;

emergencyActive=true;

/* STOP TIMERS */
clearInterval(mainTimer);
clearInterval(popupTimer);

popupActive=false;

/* CLOSE POPUP */
document.getElementById("checkPopup")
.style.display="none";

/* CHANGE UI */
document.getElementById("timer")
.innerHTML="üö® EMERGENCY ACTIVE";

/*RESET BUTTON*/
document.getElementById("resetBtn")
.style.display="inline-block";

/* SEND ALERT */
getLocation((lat,lon)=>{

localStorage.setItem("panicActive","true");
localStorage.setItem("panicLat",lat);
localStorage.setItem("panicLon",lon);
localStorage.setItem("panicUser",userName);

alert("üö® Panic Alert Sent");

window.open("police.html");

});

log("Police alerted");

}

/* AUTO PANIC */
function autoPanic(){
manualPanic();

}


/* ======================
START SYSTEM
======================*/

startMainTimer();

function resetSystem(){

emergencyActive=false;

/* CLEAR STORAGE */
localStorage.removeItem("panicActive");
localStorage.removeItem("panicLat");
localStorage.removeItem("panicLon");
localStorage.removeItem("policeReply");

/* RESET TIMER */
timeLeft = interval*60;
updateTimerDisplay();

/* HIDE RESET BUTTON */
document.getElementById("resetBtn").style.display="none";

/* RESTART MONITORING */
clearInterval(mainTimer);
startMainTimer();

log("System Reset");

alert("‚úÖ Monitoring Restarted");

}
</script>


</body>
</html>
